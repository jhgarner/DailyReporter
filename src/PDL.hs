{-# LANGUAGE OverloadedStrings #-}

module PDL
  ( pdl,
  )
where

import qualified Data.ByteString as B
import qualified Data.ByteString.Lazy as LB
import Data.HashMap.Strict (toList)
import qualified Data.Map as M
import Data.Maybe
import Data.Text
import Data.Text.Encoding
import Data.Text.IO
import Network.HTTP.Conduit (simpleHttp)
import Parser
import Text.HTML.Scalpel
import Text.Regex.Posix
import Utils

-- | The final html text generated by scraping poorlydrawnlines.com as well as
--  |their RSS feeds
pdl :: (Text -> LB.ByteString -> IO Text) -> IO Text
pdl upload = do
  h <- htmlS
  -- Unfortunately the title is only in the RSS feed...
  title <- getTitle pdlFeed
  guide <- Data.Text.IO.readFile "parsers/pdl.json"
  html <- getHttp "https://poorlydrawnlines.com/"
  let result = toList $ fromJust $ extractHtml guide html
  picture <- simpleHttp $ unpack $ M.fromList result M.! "*img"
  url <- upload (replace " " "_" title) picture
  pure $ template [("*title", title), ("*img", "https://daily-reporter-cache.s3.amazonaws.com/" <> url)] h

-- | PDL feed URL
pdlFeed :: String
pdlFeed = "http://feeds.feedburner.com/PoorlyDrawnLines"

-- | Get poorly drawn lines template (templates/PDL.html)
htmlS :: IO Text
htmlS = Data.Text.IO.readFile "templates/PDL.html"
